<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI TabMesh ‚Äî E2E Encrypted P2P Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0e17;
            color: #e0e6f0;
            min-height: 100vh;
            padding: 24px;
        }

        h1 {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #00d4ff, #7b61ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .subtitle {
            font-size: 0.78rem;
            color: #6b7a99;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px 18px;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6b7a99;
            margin-bottom: 2px;
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        .stat-val.cyan {
            color: #00d4ff;
        }

        .stat-val.gold {
            color: #ffd54f;
        }

        .stat-val.green {
            color: #00e676;
        }

        .stat-val.purple {
            color: #b388ff;
        }

        .stat-val.red {
            color: #ff5252;
        }

        .panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .panel-hd {
            padding: 10px 16px;
            font-size: 0.82rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .panel-bd {
            padding: 12px 16px;
        }

        .peer-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 0.78rem;
        }

        .peer-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00e676;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        .peer-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            color: #00d4ff;
        }

        .peer-meta {
            font-size: 0.68rem;
            color: #6b7a99;
            margin-left: auto;
        }

        .log-area {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.72rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-area .t {
            color: #6b7a99;
        }

        .log-area .s {
            color: #00e676;
        }

        .log-area .w {
            color: #ffd54f;
        }

        .log-area .e {
            color: #ff5252;
        }

        .log-area .i {
            color: #e0e6f0;
        }

        .log-area .c {
            color: #b388ff;
        }

        /* crypto */

        .btn {
            background: linear-gradient(135deg, #00d4ff, #7b61ff);
            color: #0a0e17;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .infer-wrap {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .infer-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e0e6f0;
            font-size: 0.82rem;
        }

        .cipher-block {
            background: rgba(255, 82, 82, 0.08);
            border: 1px solid rgba(255, 82, 82, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 6px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            color: #ff8a80;
            word-break: break-all;
            line-height: 1.5;
        }

        .cipher-block .label {
            color: #ff5252;
            font-weight: 600;
            font-size: 0.7rem;
            margin-bottom: 4px;
        }

        .e2e-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .e2e-badge.locked {
            background: rgba(0, 230, 118, 0.15);
            color: #00e676;
        }

        .e2e-badge.open {
            background: rgba(255, 82, 82, 0.15);
            color: #ff5252;
        }

        .instructions {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.15);
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 20px;
            font-size: 0.78rem;
            line-height: 1.6;
        }

        .instructions strong {
            color: #00d4ff;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 900px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <h1>üîí CDI TabMesh ‚Äî E2E Encrypted P2P Test</h1>
    <p class="subtitle">Open in 3 tabs: Tab A sends, Tab B executes, Tab C eavesdrops (sees only ciphertext)</p>

    <div class="instructions">
        <strong>E2E Encryption Test (3 tabs):</strong><br>
        1. Open this page in <strong>Tab A</strong> ‚Üí click "Start Node"<br>
        2. Open in <strong>Tab B</strong> ‚Üí click "Start Node" ‚Üí peers discover + exchange ECDH keys<br>
        3. Open in <strong>Tab C</strong> ‚Üí click "Start Node" ‚Üí 3-way mesh established<br>
        4. In <strong>Tab A</strong>: send an inference ‚Üí encrypted for Tab B only<br>
        5. <strong>Tab B</strong>: decrypts + processes ‚Üí sends encrypted response back to Tab A<br>
        6. <strong>Tab C</strong>: sees the BroadcastChannel message but <strong>CANNOT decrypt</strong> the prompt üö´
    </div>

    <div class="status-bar">
        <div class="stat">
            <div class="stat-label">This Node</div>
            <div class="stat-val cyan" id="nodeId">‚Äî</div>
        </div>
        <div class="stat">
            <div class="stat-label">Peers</div>
            <div class="stat-val green" id="peerCount">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">E2E Keys</div>
            <div class="stat-val gold" id="e2eCount">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">Inferences</div>
            <div class="stat-val purple" id="infCount">0</div>
        </div>
        <div class="stat">
            <div class="stat-label">üö´ Drops</div>
            <div class="stat-val red" id="dropCount">0</div>
        </div>
    </div>

    <div class="actions">
        <button class="btn" id="btnStart" onclick="startMesh()">üöÄ Start Node</button>
        <button class="btn" id="btnStop" onclick="stopMesh()" disabled>‚èπ Stop</button>
    </div>

    <div class="panel">
        <div class="panel-hd">üì° Connected Peers (E2E Status)</div>
        <div class="panel-bd" id="peerList">
            <div style="color:#6b7a99;font-size:0.78rem">No peers yet ‚Äî start node and open more tabs</div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-hd">ü§ñ Encrypted Inference Test</div>
        <div class="panel-bd">
            <div style="font-size:0.75rem;color:#6b7a99;margin-bottom:8px">
                Prompt is E2E encrypted with ECDH+AES-256-GCM ‚Äî only the target peer can read it.
                Other tabs see ciphertext only.
            </div>
            <div class="infer-wrap">
                <input type="text" class="infer-input" id="inferPrompt" placeholder="Enter a secret prompt‚Ä¶"
                    value="This is a TOP SECRET prompt that only the executor should see">
                <button class="btn" onclick="sendInference()" id="btnInfer" disabled>üîí Send Encrypted</button>
            </div>
            <div id="inferResult" style="margin-top:10px;font-size:0.78rem;color:#6b7a99"></div>
        </div>
    </div>

    <div class="two-col">
        <div class="panel">
            <div class="panel-hd">üìã Event Log</div>
            <div class="panel-bd">
                <div class="log-area" id="logArea"></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-hd">üö´ Eavesdropper Drops (encrypted messages this node CAN'T read)</div>
            <div class="panel-bd">
                <div class="log-area" id="dropArea">
                    <div style="color:#6b7a99;font-size:0.72rem">
                        If you see entries here, E2E is working ‚Äî this node received encrypted
                        messages intended for someone else and CANNOT decrypt them.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { TabMesh } from './browser/p2p/TabMesh.js';

        let mesh = null;
        let startTime = null;
        let infCount = 0;
        let dropCount = 0;
        const pendingInferences = new Map();

        function genPeerId() {
            const arr = new Uint8Array(16);
            crypto.getRandomValues(arr);
            return 'CDI-' + Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 24);
        }

        function log(msg, level = 'i') {
            const a = document.getElementById('logArea');
            const t = new Date().toLocaleTimeString();
            a.innerHTML += `<div class="fade-in"><span class="t">[${t}]</span> <span class="${level}">${msg}</span></div>`;
            a.scrollTop = a.scrollHeight;
        }

        function logDrop(msg) {
            const a = document.getElementById('dropArea');
            const t = new Date().toLocaleTimeString();
            a.innerHTML += `<div class="fade-in"><span class="t">[${t}]</span> <span class="e">${msg}</span></div>`;
            a.scrollTop = a.scrollHeight;
        }

        function updatePeerUI() {
            const peers = mesh ? mesh.getPeers() : [];
            document.getElementById('peerCount').textContent = peers.length;
            document.getElementById('e2eCount').textContent = mesh ? mesh.e2e.peerCount : 0;

            const el = document.getElementById('peerList');
            if (peers.length === 0) {
                el.innerHTML = '<div style="color:#6b7a99;font-size:0.78rem">No peers yet ‚Äî open more tabs!</div>';
                return;
            }
            el.innerHTML = peers.map(p => {
                const hasE2E = mesh.e2e.hasPeer(p.peerId);
                return `
                    <div class="peer-row fade-in">
                        <div class="peer-dot"></div>
                        <span class="peer-id">${p.peerId.slice(0, 20)}‚Ä¶</span>
                        <span class="e2e-badge ${hasE2E ? 'locked' : 'open'}">${hasE2E ? 'üîí E2E' : 'üîì OPEN'}</span>
                        <span class="peer-meta">
                            GPU: ${p.gpu ? '‚úÖ' : '‚ùå'} |
                            Up: ${p.uptime || 0}s |
                            Inf: ${p.inferences || 0}
                        </span>
                    </div>
                `;
            }).join('');
        }

        window.startMesh = async function() {
            const peerId = genPeerId();
            document.getElementById('nodeId').textContent = peerId.slice(0, 16) + '‚Ä¶';
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('btnInfer').disabled = false;
            startTime = Date.now();

            mesh = new TabMesh({
                peerId,
                ethAddress: '0x' + peerId.slice(4, 44),
                onPeer: (peer) => {
                    log(`‚úÖ PEER: ${peer.peerId.slice(0, 16)}‚Ä¶ (E2E: ${peer.e2e ? 'üîí' : 'üîì'}) ‚Äî Total: ${peer.total}`, 's');
                    updatePeerUI();
                },
                onPeerLost: (peer) => {
                    log(`‚ùå PEER LOST: ${peer.peerId.slice(0, 16)}‚Ä¶ ‚Äî Total: ${peer.total}`, 'w');
                    updatePeerUI();
                },
                onMessage: (msg) => {
                    // Handle inference response (decrypted or unencrypted)
                    if (msg.type === 'inference:res') {
                        const cb = pendingInferences.get(msg.id);
                        if (cb) {
                            cb(msg);
                            pendingInferences.delete(msg.id);
                        }
                    } else {
                        log(`üì® Message: ${msg.type} from ${msg.from?.slice(0, 12)}‚Ä¶`);
                    }
                },
                onInferenceReq: (req) => {
                    const decLabel = req.decrypted ? 'üîí DECRYPTED' : 'üîì PLAINTEXT';
                    log(`ü§ñ Inference [${decLabel}] from ${req.from?.slice(0, 12)}‚Ä¶: "${req.prompt?.slice(0, 50)}‚Ä¶"`, 'c');

                    // Simulate local inference
                    const fakeResult = `[${peerId.slice(0, 8)}] I can see the prompt: "${req.prompt?.slice(0, 40)}‚Ä¶" ‚Äî Simulated response (${Math.floor(Math.random() * 500 + 100)}ms)`;
                    infCount++;
                    document.getElementById('infCount').textContent = infCount;

                    setTimeout(async () => {
                        // Respond with E2E encryption back to requester
                        await mesh.respondInference(req.id, fakeResult, req.from);
                        log(`‚úÖ Response sent [üîí encrypted for ${req.from?.slice(0, 12)}‚Ä¶]`, 's');
                    }, Math.random() * 800 + 200);
                },
                onEncryptedDrop: (drop) => {
                    dropCount++;
                    document.getElementById('dropCount').textContent = dropCount;
                    logDrop(`üö´ ENCRYPTED msg [${drop.reason}] ‚Äî from: ${drop.from?.slice(0, 12)}‚Ä¶ ‚Üí target: ${drop.targetPeerId?.slice(0, 12) || '?'}‚Ä¶`);
                    if (drop.ciphertextPreview) {
                        logDrop(`   ciphertext: ${drop.ciphertextPreview}`);
                    }
                    logDrop(`   ‚ö†Ô∏è This node CANNOT read the prompt ‚Äî E2E encryption working!`);
                },
            });

            // Wire metrics
            mesh._getUptime = () => Math.floor((Date.now() - startTime) / 1000);
            mesh._getInferences = () => infCount;
            mesh._getEarnings = () => infCount * 1.5;

            await mesh.start();
            log(`üöÄ Node started: ${peerId}`, 's');
            log('üîê ECDH P-256 keypair generated ‚Äî E2E encryption ready', 'c');
            log('Waiting for peers‚Ä¶ Open this page in more browser tabs!');

            // Uptime counter
            setInterval(() => {
                updatePeerUI();
            }, 1000);
        };

        window.stopMesh = function() {
            if (mesh) {
                mesh.stop();
                mesh = null;
            }
            startTime = null;
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('btnInfer').disabled = true;
            document.getElementById('peerCount').textContent = '0';
            document.getElementById('e2eCount').textContent = '0';
            document.getElementById('nodeId').textContent = '‚Äî';
            log('‚èπ Node stopped', 'w');
        };

        window.sendInference = async function() {
            if (!mesh || mesh.getPeerCount() === 0) {
                log('‚ö†Ô∏è No peers connected ‚Äî open more tabs first!', 'w');
                return;
            }
            const prompt = document.getElementById('inferPrompt').value.trim();
            if (!prompt) return;

            const id = 'inf-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
            document.getElementById('inferResult').innerHTML = '<span style="color:#ffd54f">‚è≥ Encrypting + distributing to peers‚Ä¶</span>';
            log(`üì§ Sending encrypted inference: "${prompt.slice(0, 40)}‚Ä¶"`, 'c');

            // Wait for response
            const timeout = setTimeout(() => {
                pendingInferences.delete(id);
                document.getElementById('inferResult').innerHTML = '<span style="color:#ff5252">‚è∞ Timeout ‚Äî no peer responded in 10s</span>';
                log('‚è∞ Inference timeout', 'w');
            }, 10000);

            pendingInferences.set(id, (msg) => {
                clearTimeout(timeout);
                infCount++;
                document.getElementById('infCount').textContent = infCount;
                const decLabel = msg.decrypted ? 'üîí E2E Decrypted' : 'üîì Plaintext';
                document.getElementById('inferResult').innerHTML = `
                    <div style="color:#00e676;font-weight:600;margin-bottom:4px">‚úÖ Response from ${msg.peerId?.slice(0, 16)}‚Ä¶ [${decLabel}]</div>
                    <div style="color:#e0e6f0;font-size:0.82rem">${msg.output}</div>
                `;
                log(`‚úÖ Response received [${decLabel}] from ${msg.peerId?.slice(0, 12)}‚Ä¶`, 's');
            });

            // Send encrypted inference (target = first available peer)
            await mesh.requestInference(id, prompt, 'llama3.1:8b');
        };
    </script>
</body>

</html>